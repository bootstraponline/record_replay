import t from"path";import r from"fs-extra";import{assert as e}from"@pollyjs/utils";import n from"cors";import o from"morgan";import i from"express";import c from"http-graceful-shutdown";import u from"body-parser";import s from"nocache";class f{constructor(t={}){const{recordingsDir:r}=t;e(`Invalid recordings directory provided. Expected string, received: "${typeof r}".`,"string"==typeof r),this.recordingsDir=r}getRecording(t){const e=this.filenameFor(t);return r.existsSync(e)?this.respond(200,r.readJsonSync(e)):this.respond(204)}saveRecording(t,e){return r.outputJsonSync(this.filenameFor(t),e,{spaces:2}),this.respond(201)}deleteRecording(t){const e=this.filenameFor(t);return r.existsSync(e)&&r.removeSync(e),this.respond(200)}filenameFor(r){return t.join(this.recordingsDir,r,"recording.har")}respond(t,r){return{status:t,body:r}}}var a={}.toString,p=function(t){return a.call(t).slice(8,-1)},l=Object("z").propertyIsEnumerable(0)?Object:function(t){return"String"==p(t)?t.split(""):Object(t)},y=function(t){if(null==t)throw TypeError("Can't call method on  "+t);return t},h=function(t){return l(y(t))},d={f:{}.propertyIsEnumerable},g=function(t,r){return{enumerable:!(1&t),configurable:!(2&t),writable:!(4&t),value:r}},m=function(t){return"object"==typeof t?null!==t:"function"==typeof t},v=function(t,r){if(!m(t))return t;var e,n;if(r&&"function"==typeof(e=t.toString)&&!m(n=e.call(t)))return n;if("function"==typeof(e=t.valueOf)&&!m(n=e.call(t)))return n;if(!r&&"function"==typeof(e=t.toString)&&!m(n=e.call(t)))return n;throw TypeError("Can't convert object to primitive value")},b={}.hasOwnProperty,O=function(t,r){return b.call(t,r)},S=function(t){try{return!!t()}catch(t){return!0}},w=!S(function(){return 7!=Object.defineProperty({},"a",{get:function(){return 7}}).a});function j(t,r){return t(r={exports:{}},r.exports),r.exports}var P=j(function(t){var r=t.exports="undefined"!=typeof window&&window.Math==Math?window:"undefined"!=typeof self&&self.Math==Math?self:Function("return this")();"number"==typeof __g&&(__g=r)}),E=P.document,_=m(E)&&m(E.createElement),F=function(t){return _?E.createElement(t):{}},N=!w&&!S(function(){return 7!=Object.defineProperty(F("div"),"a",{get:function(){return 7}}).a}),x=Object.getOwnPropertyDescriptor,D={f:w?x:function(t,r){if(t=h(t),r=v(r,!0),N)try{return x(t,r)}catch(t){}if(O(t,r))return g(!d.f.call(t,r),t[r])}},k=j(function(t){var r=t.exports={version:"2.6.9"};"number"==typeof __e&&(__e=r)}),M=(k.version,function(t,r,e){if(function(t){if("function"!=typeof t)throw TypeError(t+" is not a function!")}(t),void 0===r)return t;switch(e){case 1:return function(e){return t.call(r,e)};case 2:return function(e,n){return t.call(r,e,n)};case 3:return function(e,n,o){return t.call(r,e,n,o)}}return function(){return t.apply(r,arguments)}}),R=function(t){if(!m(t))throw TypeError(t+" is not an object!");return t},T=Object.defineProperty,I={f:w?Object.defineProperty:function(t,r,e){if(R(t),r=v(r,!0),R(e),N)try{return T(t,r,e)}catch(t){}if("get"in e||"set"in e)throw TypeError("Accessors not supported!");return"value"in e&&(t[r]=e.value),t}},W=w?function(t,r,e){return I.f(t,r,g(1,e))}:function(t,r,e){return t[r]=e,t},A=function(t,r,e){var n,o,i,c=t&A.F,u=t&A.G,s=t&A.S,f=t&A.P,a=t&A.B,p=t&A.W,l=u?k:k[r]||(k[r]={}),y=l.prototype,h=u?P:s?P[r]:(P[r]||{}).prototype;for(n in u&&(e=r),e)(o=!c&&h&&void 0!==h[n])&&O(l,n)||(i=o?h[n]:e[n],l[n]=u&&"function"!=typeof h[n]?e[n]:a&&o?M(i,P):p&&h[n]==i?function(t){var r=function(r,e,n){if(this instanceof t){switch(arguments.length){case 0:return new t;case 1:return new t(r);case 2:return new t(r,e)}return new t(r,e,n)}return t.apply(this,arguments)};return r.prototype=t.prototype,r}(i):f&&"function"==typeof i?M(Function.call,i):i,f&&((l.virtual||(l.virtual={}))[n]=i,t&A.R&&y&&!y[n]&&W(y,n,i)))};A.F=1,A.G=2,A.S=4,A.P=8,A.B=16,A.W=32,A.U=64,A.R=128;var z=A,J=function(t,r){var e=(k.Object||{})[t]||Object[t],n={};n[t]=r(e),z(z.S+z.F*S(function(){e(1)}),"Object",n)},C=D.f;J("getOwnPropertyDescriptor",function(){return function(t,r){return C(h(t),r)}});var K,$=k.Object,L=function(t,r){return $.getOwnPropertyDescriptor(t,r)},q=W,G=0,Y=Math.random(),B=function(t){return"Symbol(".concat(void 0===t?"":t,")_",(++G+Y).toString(36))},U=j(function(t){var r=B("meta"),e=I.f,n=0,o=Object.isExtensible||function(){return!0},i=!S(function(){return o(Object.preventExtensions({}))}),c=function(t){e(t,r,{value:{i:"O"+ ++n,w:{}}})},u=t.exports={KEY:r,NEED:!1,fastKey:function(t,e){if(!m(t))return"symbol"==typeof t?t:("string"==typeof t?"S":"P")+t;if(!O(t,r)){if(!o(t))return"F";if(!e)return"E";c(t)}return t[r].i},getWeak:function(t,e){if(!O(t,r)){if(!o(t))return!0;if(!e)return!1;c(t)}return t[r].w},onFreeze:function(t){return i&&u.NEED&&o(t)&&!O(t,r)&&c(t),t}}}),Q=(U.KEY,U.NEED,U.fastKey,U.getWeak,U.onFreeze,j(function(t){var r=P["__core-js_shared__"]||(P["__core-js_shared__"]={});(t.exports=function(t,e){return r[t]||(r[t]=void 0!==e?e:{})})("versions",[]).push({version:k.version,mode:"pure",copyright:"Â© 2019 Denis Pushkarev (zloirock.ru)"})})),H=j(function(t){var r=Q("wks"),e=P.Symbol,n="function"==typeof e;(t.exports=function(t){return r[t]||(r[t]=n&&e[t]||(n?e:B)("Symbol."+t))}).store=r}),V=I.f,X=H("toStringTag"),Z=function(t,r,e){t&&!O(t=e?t:t.prototype,X)&&V(t,X,{configurable:!0,value:r})},tt={f:H},rt=I.f,et=function(t){var r=k.Symbol||(k.Symbol={});"_"==t.charAt(0)||t in r||rt(r,t,{value:tt.f(t)})},nt=Math.ceil,ot=Math.floor,it=function(t){return isNaN(t=+t)?0:(t>0?ot:nt)(t)},ct=Math.min,ut=Math.max,st=Math.min,ft=Q("keys"),at=function(t){return ft[t]||(ft[t]=B(t))},pt=(K=!1,function(t,r,e){var n,o,i=h(t),c=(n=i.length)>0?ct(it(n),9007199254740991):0,u=function(t,r){return(t=it(t))<0?ut(t+r,0):st(t,r)}(e,c);if(K&&r!=r){for(;c>u;)if((o=i[u++])!=o)return!0}else for(;c>u;u++)if((K||u in i)&&i[u]===r)return K||u||0;return!K&&-1}),lt=at("IE_PROTO"),yt=function(t,r){var e,n=h(t),o=0,i=[];for(e in n)e!=lt&&O(n,e)&&i.push(e);for(;r.length>o;)O(n,e=r[o++])&&(~pt(i,e)||i.push(e));return i},ht="constructor,hasOwnProperty,isPrototypeOf,propertyIsEnumerable,toLocaleString,toString,valueOf".split(","),dt=Object.keys||function(t){return yt(t,ht)},gt={f:Object.getOwnPropertySymbols},mt=Array.isArray||function(t){return"Array"==p(t)},vt=function(t){return Object(y(t))},bt=w?Object.defineProperties:function(t,r){R(t);for(var e,n=dt(r),o=n.length,i=0;o>i;)I.f(t,e=n[i++],r[e]);return t},Ot=P.document,St=Ot&&Ot.documentElement,wt=at("IE_PROTO"),jt=function(){},Pt=function(){var t,r=F("iframe"),e=ht.length;for(r.style.display="none",St.appendChild(r),r.src="javascript:",(t=r.contentWindow.document).open(),t.write("<script>document.F=Object<\/script>"),t.close(),Pt=t.F;e--;)delete Pt.prototype[ht[e]];return Pt()},Et=Object.create||function(t,r){var e;return null!==t?(jt.prototype=R(t),e=new jt,jt.prototype=null,e[wt]=t):e=Pt(),void 0===r?e:bt(e,r)},_t=ht.concat("length","prototype"),Ft={f:Object.getOwnPropertyNames||function(t){return yt(t,_t)}},Nt=Ft.f,xt={}.toString,Dt="object"==typeof window&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[],kt={f:function(t){return Dt&&"[object Window]"==xt.call(t)?function(t){try{return Nt(t)}catch(t){return Dt.slice()}}(t):Nt(h(t))}},Mt=U.KEY,Rt=D.f,Tt=I.f,It=kt.f,Wt=P.Symbol,At=P.JSON,zt=At&&At.stringify,Jt=H("_hidden"),Ct=H("toPrimitive"),Kt={}.propertyIsEnumerable,$t=Q("symbol-registry"),Lt=Q("symbols"),qt=Q("op-symbols"),Gt=Object.prototype,Yt="function"==typeof Wt&&!!gt.f,Bt=P.QObject,Ut=!Bt||!Bt.prototype||!Bt.prototype.findChild,Qt=w&&S(function(){return 7!=Et(Tt({},"a",{get:function(){return Tt(this,"a",{value:7}).a}})).a})?function(t,r,e){var n=Rt(Gt,r);n&&delete Gt[r],Tt(t,r,e),n&&t!==Gt&&Tt(Gt,r,n)}:Tt,Ht=function(t){var r=Lt[t]=Et(Wt.prototype);return r._k=t,r},Vt=Yt&&"symbol"==typeof Wt.iterator?function(t){return"symbol"==typeof t}:function(t){return t instanceof Wt},Xt=function(t,r,e){return t===Gt&&Xt(qt,r,e),R(t),r=v(r,!0),R(e),O(Lt,r)?(e.enumerable?(O(t,Jt)&&t[Jt][r]&&(t[Jt][r]=!1),e=Et(e,{enumerable:g(0,!1)})):(O(t,Jt)||Tt(t,Jt,g(1,{})),t[Jt][r]=!0),Qt(t,r,e)):Tt(t,r,e)},Zt=function(t,r){R(t);for(var e,n=function(t){var r=dt(t),e=gt.f;if(e)for(var n,o=e(t),i=d.f,c=0;o.length>c;)i.call(t,n=o[c++])&&r.push(n);return r}(r=h(r)),o=0,i=n.length;i>o;)Xt(t,e=n[o++],r[e]);return t},tr=function(t){var r=Kt.call(this,t=v(t,!0));return!(this===Gt&&O(Lt,t)&&!O(qt,t))&&(!(r||!O(this,t)||!O(Lt,t)||O(this,Jt)&&this[Jt][t])||r)},rr=function(t,r){if(t=h(t),r=v(r,!0),t!==Gt||!O(Lt,r)||O(qt,r)){var e=Rt(t,r);return!e||!O(Lt,r)||O(t,Jt)&&t[Jt][r]||(e.enumerable=!0),e}},er=function(t){for(var r,e=It(h(t)),n=[],o=0;e.length>o;)O(Lt,r=e[o++])||r==Jt||r==Mt||n.push(r);return n},nr=function(t){for(var r,e=t===Gt,n=It(e?qt:h(t)),o=[],i=0;n.length>i;)!O(Lt,r=n[i++])||e&&!O(Gt,r)||o.push(Lt[r]);return o};Yt||(q((Wt=function(){if(this instanceof Wt)throw TypeError("Symbol is not a constructor!");var t=B(arguments.length>0?arguments[0]:void 0),r=function(e){this===Gt&&r.call(qt,e),O(this,Jt)&&O(this[Jt],t)&&(this[Jt][t]=!1),Qt(this,t,g(1,e))};return w&&Ut&&Qt(Gt,t,{configurable:!0,set:r}),Ht(t)}).prototype,"toString",function(){return this._k}),D.f=rr,I.f=Xt,Ft.f=kt.f=er,d.f=tr,gt.f=nr,tt.f=function(t){return Ht(H(t))}),z(z.G+z.W+z.F*!Yt,{Symbol:Wt});for(var or="hasInstance,isConcatSpreadable,iterator,match,replace,search,species,split,toPrimitive,toStringTag,unscopables".split(","),ir=0;or.length>ir;)H(or[ir++]);for(var cr=dt(H.store),ur=0;cr.length>ur;)et(cr[ur++]);z(z.S+z.F*!Yt,"Symbol",{for:function(t){return O($t,t+="")?$t[t]:$t[t]=Wt(t)},keyFor:function(t){if(!Vt(t))throw TypeError(t+" is not a symbol!");for(var r in $t)if($t[r]===t)return r},useSetter:function(){Ut=!0},useSimple:function(){Ut=!1}}),z(z.S+z.F*!Yt,"Object",{create:function(t,r){return void 0===r?Et(t):Zt(Et(t),r)},defineProperty:Xt,defineProperties:Zt,getOwnPropertyDescriptor:rr,getOwnPropertyNames:er,getOwnPropertySymbols:nr});var sr=S(function(){gt.f(1)});z(z.S+z.F*sr,"Object",{getOwnPropertySymbols:function(t){return gt.f(vt(t))}}),At&&z(z.S+z.F*(!Yt||S(function(){var t=Wt();return"[null]"!=zt([t])||"{}"!=zt({a:t})||"{}"!=zt(Object(t))})),"JSON",{stringify:function(t){for(var r,e,n=[t],o=1;arguments.length>o;)n.push(arguments[o++]);if(e=r=n[1],(m(r)||void 0!==t)&&!Vt(t))return mt(r)||(r=function(t,r){if("function"==typeof e&&(r=e.call(this,t,r)),!Vt(r))return r}),n[1]=r,zt.apply(At,n)}}),Wt.prototype[Ct]||W(Wt.prototype,Ct,Wt.prototype.valueOf),Z(Wt,"Symbol"),Z(Math,"Math",!0),Z(P.JSON,"JSON",!0);var fr=k.Object.getOwnPropertySymbols;J("keys",function(){return function(t){return dt(vt(t))}});var ar=k.Object.keys;z(z.S+z.F*!w,"Object",{defineProperty:I.f});var pr=k.Object,lr=function(t,r,e){return pr.defineProperty(t,r,e)};var yr=function(t,r,e){return r in t?lr(t,r,{value:e,enumerable:!0,configurable:!0,writable:!0}):t[r]=e,t};var hr=function(t){for(var r=1;r<arguments.length;r++){var e=null!=arguments[r]?arguments[r]:{},n=ar(e);"function"==typeof fr&&(n=n.concat(fr(e).filter(function(t){return L(e,t).enumerable}))),n.forEach(function(r){yr(t,r,e[r])})}return t},dr={port:3e3,quiet:!1,recordingSizeLimit:"50mb",recordingsDir:"recordings",apiNamespace:"polly"};function gr(t,r){(r=hr({},dr,r)).apiNamespace=function(t=""){return t.startsWith("/")?t:`/${t}`}(r.apiNamespace);const e=i.Router(),n=new f({recordingsDir:r.recordingsDir});e.use(s()),e.get("/:recording",function(t,r){const{recording:e}=t.params,{status:o,body:i}=n.getRecording(e);r.status(o),200===o?r.json(i):r.end()}),e.post("/:recording",u.json({limit:r.recordingSizeLimit}),function(t,r){const{recording:e}=t.params,{status:o,body:i}=n.saveRecording(e,t.body);r.status(o).send(i)}),e.delete("/:recording",function(t,r){const{recording:e}=t.params,{status:o,body:i}=n.deleteRecording(e);r.status(o).send(i)}),t.use(r.apiNamespace,e)}class mr{constructor(t={}){this.config=hr({},dr,t),this.app=i(),this.app.use(n()),this.config.quiet||this.app.use(o("dev")),this.app.get("/",(t,r)=>r.sendStatus(200)),this.app.head("/",(t,r)=>r.sendStatus(200)),gr(this.app,{recordingsDir:this.config.recordingsDir,apiNamespace:this.config.apiNamespace})}listen(t,r){if(!this.server)return t=t||this.config.port,r=r||this.config.host,this.server=this.app.listen(t,r).on("listening",()=>{this.config.quiet||console.log(`Listening on http://${r||"localhost"}:${t}/\n`)}).on("error",r=>{"EADDRINUSE"===r.code?(console.error(`Port ${t} already in use.`),process.exit(1)):console.error(r)}),c(this.server),this.server}}export{f as API,dr as Defaults,mr as Server,gr as registerExpressAPI};
//# sourceMappingURL=pollyjs-node-server.min.js.map
